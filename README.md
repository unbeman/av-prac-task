# av-prac-task
Сервис динамического сегментирования пользователей. ТЗ от Авито


#### Билд и запуск сервиса в Docker'e:
- make dc-up 

#### Приложение:
- http://127.0.0.1:8080

#### Swagger UI:
- http://127.0.0.1:8080/swagger/index.html


### Что сделано:
- Основное задание
- Дополнительное задание 1
- Дополнительное задание 3
- Тесты на http handler'ы с mock базой
- Документирование кода


### Что использовалось:
- PostgreSQL для хранения данных
- GORM для работы с базой, в том числе миграций
- Chi для роутинга
- Swagger для генерации документации по API

### Основное задание
1. Метод создания сегмента был дополнен с учетом задания 3.
   - Если сегмент с заданным название уже существует в базе, даже если он помечен как удален, то создать сегмент с таким же названием не получится.
По Slug (названиям) построен уникальный индекс в базе.
2. Метод удаления сегмента был изменен с учетом задания 1. 
   - Сегменты не удаляются из базы данных, а помечаются как удаленные (выставляется время удаления deleted_at), и в то же время отношения пользователей к этому сегменту помечается как удаленные.
3. Метод добавления пользователя в сегмент.
   - Сегменты пользователей добавляются и удаляются в синхронном режиме. Так что пользователь ждет конца выполнения добавления/удаления в базе.
   - Также вместо полного удаления сегментов пользователя они лишь помечаются удаленными. 
4. Метод получения активных сегментов пользователя.
   - Формируется и возвращается список названий сегментов в которых состоит пользователь.

### Дополнительное задание 1 - сохранение истории операций по сегментам пользователя.
Для реализации задания, был написан пул воркеров, который асинхронно обрабатывает входящие по буферизированному каналу задачи на генерацию отчета по пользователю.
Соответственно пользователь не ждет пока отчет будет сформирован, а сразу получает ссылку по которой можно скачать отчет после окончания генерации.
Так как нам нужна полная история, то сегменты пользователя никогда не удаляются, а лишь помечаются как удаленные.
В дальнейшем можно создать крон для очистки базы от давно удаленных сегментов.

### Дополнительное задание 3 - автоматическое добавление пользователей в сегмент.
Сразу после создания нового сегмента (синхронно) выбирается пул пользователей которым добавляется новый сегмент.
Выборка происходит с использованием функции random() в самом запросе базы данных (что на самом деле достаточно медленно).
Это довольно длительный процесс, который в будущем лучше сделать асинхронным по примеру первого задания или с использованием брокера сообщений.
